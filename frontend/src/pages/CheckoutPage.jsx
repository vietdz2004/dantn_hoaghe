import React, { useState, useContext } from 'react';
import { useNavigate } from 'react-router-dom';
import { Stepper, Step, StepLabel, Button, Typography, Box, Paper, TextField, RadioGroup, FormControlLabel, Radio, CircularProgress } from '@mui/material';
import { CartContext } from '../contexts/CartContext';
import AuthContext from '../contexts/AuthContext';
import api from '../services/api';

const steps = ['Th√¥ng tin kh√°ch h√†ng', 'ƒê·ªãa ch·ªâ giao h√†ng', 'Ph∆∞∆°ng th·ª©c thanh to√°n', 'X√°c nh·∫≠n ƒë∆°n h√†ng'];

const initialCustomerInfo = {
  name: '',
  phone: '',
  email: '',
};
const initialShipping = {
  address: '',
  note: '',
};

const CheckoutPage = () => {
  const { cartItems, totalAmount, clearCart } = useContext(CartContext);
  const { user } = useContext(AuthContext);
  const navigate = useNavigate();

  const [activeStep, setActiveStep] = useState(0);
  const [customerInfo, setCustomerInfo] = useState({ ...initialCustomerInfo, ...(user ? { name: user.hoTen, phone: user.soDienThoai, email: user.email } : {}) });
  const [shipping, setShipping] = useState(initialShipping);
  const [paymentMethod, setPaymentMethod] = useState('COD');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Validate t·ª´ng b∆∞·ªõc
  const validateStep = () => {
    if (activeStep === 0) {
      if (!customerInfo.name || !customerInfo.phone) return 'Vui l√≤ng nh·∫≠p h·ªç t√™n v√† s·ªë ƒëi·ªán tho·∫°i.';
    }
    if (activeStep === 1) {
      if (!shipping.address) return 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng.';
    }
    if (activeStep === 2) {
      if (!paymentMethod) return 'Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.';
    }
    if (activeStep === 3) {
      if (
        !customerInfo.name?.trim() || customerInfo.name.trim().length < 2 ||
        !customerInfo.phone?.trim() || customerInfo.phone.trim().length < 8 ||
        !shipping.address?.trim() || shipping.address.trim().length < 5 ||
        !paymentMethod?.trim()
      ) {
        return 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† h·ª£p l·ªá h·ªç t√™n (t·ªëi thi·ªÉu 2 k√Ω t·ª±), s·ªë ƒëi·ªán tho·∫°i (t·ªëi thi·ªÉu 8 s·ªë), ƒë·ªãa ch·ªâ giao h√†ng (t·ªëi thi·ªÉu 5 k√Ω t·ª±), ph∆∞∆°ng th·ª©c thanh to√°n!';
      }
      if (
        !cartItems ||
        !Array.isArray(cartItems) ||
        cartItems.length === 0 ||
        !cartItems.every(item => item.id_SanPham && ((item.soLuong || item.quantity) && item.gia))
      ) {
        return 'Gi·ªè h√†ng tr·ªëng ho·∫∑c kh√¥ng h·ª£p l·ªá';
      }
    }
    return '';
  };

  const handleNext = async () => {
    setError('');
    const err = validateStep();
    if (err) {
      setError(err);
      return;
    }
    if (activeStep === steps.length - 1) {
      // ƒê·∫∑t h√†ng
      setLoading(true);
      try {
        // Format cartItems data ƒë·ªÉ match backend expectation
        const formattedCartItems = cartItems.map(item => ({
          id_SanPham: item.id_SanPham,
          soLuong: item.quantity || item.soLuong || 1,
          gia: item.giaKhuyenMai || item.gia,
          giaTaiThoiDiem: item.giaKhuyenMai || item.gia,
          tenSp: item.tenSp || 'S·∫£n ph·∫©m'
        }));

        console.log('üì¶ Original cartItems:', cartItems);
        console.log('üì¶ Formatted cartItems:', formattedCartItems);
        console.log('üì¶ Creating order with data:', {
          hoTen: customerInfo.name,
          soDienThoai: customerInfo.phone,
          email: customerInfo.email,
          diaChiGiao: shipping.address,
          ghiChu: shipping.note,
          phuongThucThanhToan: paymentMethod,
          sanPham: formattedCartItems,
          tongThanhToan: totalAmount,
          id_NguoiDung: user?.id_NguoiDung
        });

        // 1. T·∫°o ƒë∆°n h√†ng
        const orderRes = await api.post('/orders', {
          hoTen: customerInfo.name,
          soDienThoai: customerInfo.phone,
          email: customerInfo.email,
          diaChiGiao: shipping.address,
          ghiChu: shipping.note,
          phuongThucThanhToan: paymentMethod,
          sanPham: formattedCartItems,
          tongThanhToan: totalAmount,
          id_NguoiDung: user?.id_NguoiDung
        });
        
        console.log('‚úÖ Order response:', orderRes);
        console.log('‚úÖ Order response data:', orderRes.data);
        
        if (!orderRes.data?.success) {
          throw new Error('API kh√¥ng tr·∫£ v·ªÅ success=true: ' + JSON.stringify(orderRes.data));
        }
        
        if (!orderRes.data?.data?.id_DonHang) {
          throw new Error('API kh√¥ng tr·∫£ v·ªÅ id_DonHang: ' + JSON.stringify(orderRes.data));
        }
        
        const order = orderRes.data.data;
        console.log('‚úÖ Order created with ID:', order.id_DonHang);
        
        // 2. X·ª≠ l√Ω thanh to√°n theo ph∆∞∆°ng th·ª©c ƒë√£ ch·ªçn
        if (paymentMethod === 'VNPay') {
          await handleVNPayPayment(order, totalAmount);
        } else if (paymentMethod === 'ZaloPay') {
          await handleZaloPayPayment(order, totalAmount);
        } else {
          // 3. Thanh to√°n COD: chuy·ªÉn sang trang th√†nh c√¥ng
          console.log('‚úÖ COD order completed, clearing cart and redirecting...');
          clearCart();
          navigate('/order-success', { state: { order } });
        }
      } catch (e) {
        console.error('‚ùå Checkout error:', e);
        console.error('‚ùå Error response:', e.response?.data);
        console.error('‚ùå Error message:', e.message);
        console.error('‚ùå Full error object:', e);
        setError(e.response?.data?.message || e.message || 'C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng.');
      } finally {
        setLoading(false);
      }
    } else {
      setActiveStep((prev) => prev + 1);
    }
  };

  // X·ª≠ l√Ω thanh to√°n VNPay
  const handleVNPayPayment = async (order, amount) => {
    console.log('üí≥ Creating VNPay payment with amount:', amount);
    const payRes = await api.post('/payment/create_payment_url', {
      amount: amount,
      orderId: order.id_DonHang,
      orderDesc: `Thanh to√°n ƒë∆°n h√†ng #${order.id_DonHang} - HoaShop`,
    });
    
    console.log('üí≥ VNPay payment response:', payRes);
    console.log('üí≥ VNPay payment response data:', payRes.data);
    
    const paymentData = payRes.data;
    if (paymentData?.success && paymentData?.paymentUrl) {
      console.log('üöÄ Redirecting to VNPay:', paymentData.paymentUrl);
      window.location.href = paymentData.paymentUrl;
    } else {
      throw new Error('VNPay kh√¥ng tr·∫£ v·ªÅ payment URL: ' + JSON.stringify(paymentData));
    }
  };

  // X·ª≠ l√Ω thanh to√°n ZaloPay
  const handleZaloPayPayment = async (order, amount) => {
    console.log('üü° Creating ZaloPay payment with amount:', amount);
    const payRes = await api.post('/payment/create_zalopay_order', {
      amount: amount,
      orderId: order.id_DonHang,
      orderDesc: `Thanh to√°n ƒë∆°n h√†ng #${order.id_DonHang} - HoaShop`,
    });
    
    console.log('üü° ZaloPay payment response:', payRes);
    console.log('üü° ZaloPay payment response data:', payRes.data);
    
    const paymentData = payRes.data;
    if (paymentData?.success && paymentData?.order_url) {
      console.log('üöÄ Redirecting to ZaloPay:', paymentData.order_url);
      window.location.href = paymentData.order_url;
    } else {
      throw new Error('ZaloPay kh√¥ng tr·∫£ v·ªÅ order URL: ' + JSON.stringify(paymentData));
    }
  };

  const handleBack = () => {
    setError('');
    setActiveStep((prev) => prev - 1);
  };

  // Render t·ª´ng b∆∞·ªõc
  const renderStepContent = (step) => {
    switch (step) {
      case 0:
        return (
          <Box>
            <TextField label="H·ªç t√™n" fullWidth margin="normal" value={customerInfo.name} onChange={e => setCustomerInfo({ ...customerInfo, name: e.target.value })} />
            <TextField label="S·ªë ƒëi·ªán tho·∫°i" fullWidth margin="normal" value={customerInfo.phone} onChange={e => setCustomerInfo({ ...customerInfo, phone: e.target.value })} />
            <TextField label="Email" fullWidth margin="normal" value={customerInfo.email} onChange={e => setCustomerInfo({ ...customerInfo, email: e.target.value })} />
          </Box>
        );
      case 1:
        return (
          <Box>
            <TextField label="ƒê·ªãa ch·ªâ giao h√†ng" fullWidth margin="normal" value={shipping.address} onChange={e => setShipping({ ...shipping, address: e.target.value })} />
            <TextField label="Ghi ch√∫" fullWidth margin="normal" value={shipping.note} onChange={e => setShipping({ ...shipping, note: e.target.value })} />
          </Box>
        );
      case 2:
        return (
          <Box>
            <RadioGroup value={paymentMethod} onChange={e => setPaymentMethod(e.target.value)}>
              <FormControlLabel value="COD" control={<Radio />} label="Thanh to√°n khi nh·∫≠n h√†ng (COD)" />
              <FormControlLabel value="VNPay" control={<Radio />} label="Thanh to√°n qua VNPay (ATM, QR, th·∫ª qu·ªëc t·∫ø)" />
              <FormControlLabel value="ZaloPay" control={<Radio />} label="Thanh to√°n qua ZaloPay (V√≠ ƒëi·ªán t·ª≠, th·∫ª ATM)" />
            </RadioGroup>
          </Box>
        );
      case 3:
        return (
          <Box>
            <Typography variant="h6">X√°c nh·∫≠n ƒë∆°n h√†ng</Typography>
            <Typography>Kh√°ch h√†ng: {customerInfo.name} - {customerInfo.phone}</Typography>
            <Typography>ƒê·ªãa ch·ªâ: {shipping.address}</Typography>
            <Typography>Ph∆∞∆°ng th·ª©c thanh to√°n: {
              paymentMethod === 'VNPay' ? 'VNPay' : 
              paymentMethod === 'ZaloPay' ? 'ZaloPay' : 'COD'
            }</Typography>
            <Typography>S·ªë s·∫£n ph·∫©m: {cartItems.length}</Typography>
            <Typography>T·ªïng ti·ªÅn: {totalAmount.toLocaleString()}‚Ç´</Typography>
          </Box>
        );
      default:
        return null;
    }
  };

  return (
    <Paper sx={{ maxWidth: 600, margin: '32px auto', p: 3 }}>
      <Stepper activeStep={activeStep} alternativeLabel>
        {steps.map(label => (
          <Step key={label}>
            <StepLabel>{label}</StepLabel>
          </Step>
        ))}
      </Stepper>
      <Box mt={3} mb={2}>{renderStepContent(activeStep)}</Box>
      {error && <Typography color="error">{error}</Typography>}
      <Box display="flex" justifyContent="space-between" alignItems="center">
        <Button disabled={activeStep === 0 || loading} onClick={handleBack}>Quay l·∫°i</Button>
        <Button variant="contained" color="primary" onClick={handleNext} disabled={loading}>
          {loading ? <CircularProgress size={24} /> : (activeStep === steps.length - 1 ? 'ƒê·∫∑t h√†ng' : 'Ti·∫øp t·ª•c')}
        </Button>
      </Box>
    </Paper>
  );
};

export default CheckoutPage; 